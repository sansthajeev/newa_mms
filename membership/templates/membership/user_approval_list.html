{% extends 'membership/base.html' %}
{% block title %}User Approval - Newa Samparka Samuha{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-person-check"></i> User Approval</h1>
        <div>
            <span class="badge bg-warning">{{ pending_count }} Pending</span>
            <span class="badge bg-success">{{ approved_count }} Approved</span>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if filter == 'pending' %}active{% endif %}" href="?filter=pending">
                <i class="bi bi-hourglass-split"></i> Pending Approval ({{ pending_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if filter == 'approved' %}active{% endif %}" href="?filter=approved">
                <i class="bi bi-check-circle"></i> Approved Users ({{ approved_count }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if filter == 'all' %}active{% endif %}" href="?filter=all">
                <i class="bi bi-people"></i> All Users ({{ all_count }})
            </a>
        </li>
    </ul>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body">
            {% if users %}
            <form method="post" id="bulkApprovalForm">
                {% csrf_token %}
                <div class="mb-3">
                    <button type="submit" name="action" value="bulk_approve" class="btn btn-success" onclick="return confirm('Approve selected users?')">
                        <i class="bi bi-check-circle"></i> Approve Selected
                    </button>
                    <button type="submit" name="action" value="bulk_unapprove" class="btn btn-warning" onclick="return confirm('Unapprove selected users?')">
                        <i class="bi bi-x-circle"></i> Unapprove Selected
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Joined</th>
                                <th>Status</th>
                                <th>Approved By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_profile in users %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="user_ids" value="{{ user_profile.id }}" class="form-check-input user-checkbox">
                                </td>
                                <td>
                                    <strong>{{ user_profile.user.username }}</strong>
                                    {% if user_profile.user.is_superuser %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% elif user_profile.user.is_staff %}
                                        <span class="badge bg-info">Staff</span>
                                    {% endif %}
                                </td>
                                <td>{{ user_profile.user.first_name }} {{ user_profile.user.last_name }}</td>
                                <td>{{ user_profile.user.email }}</td>
                                <td>{{ user_profile.user.date_joined|date:"M d, Y" }}</td>
                                <td>
                                    {% if user_profile.is_approved %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Approved
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-hourglass-split"></i> Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user_profile.approved_by %}
                                        {{ user_profile.approved_by.username }}
                                        <br><small class="text-muted">{{ user_profile.approved_at|date:"M d, Y H:i" }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-nowrap">
                                    {% if user_profile.is_approved %}
                                        <a href="{% url 'membership:user_unapprove' user_profile.id %}" 
                                           class="btn btn-sm btn-warning"
                                           onclick="return confirm('Unapprove {{ user_profile.user.username }}?')">
                                            <i class="bi bi-x-circle"></i> Unapprove
                                        </a>
                                    {% else %}
                                        <a href="{% url 'membership:user_approve' user_profile.id %}" 
                                           class="btn btn-sm btn-success"
                                           onclick="return confirm('Approve {{ user_profile.user.username }}?')">
                                            <i class="bi bi-check-circle"></i> Approve
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'membership:user_detail' user_profile.id %}" 
                                       class="btn btn-sm btn-info">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                <p class="text-muted mt-3">No users found in this category.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Select all checkbox functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Uncheck "select all" if any checkbox is unchecked
document.querySelectorAll('.user-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const allChecked = Array.from(document.querySelectorAll('.user-checkbox')).every(cb => cb.checked);
        document.getElementById('selectAll').checked = allChecked;
    });
});
</script>
{% endblock %}