{% extends 'membership/base.html' %}

{% block title %}{{ member.name }} - Member Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-person-circle"></i> Member Details</h1>
        <div>
            <a href="{% url 'membership:member_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            <a href="{% url 'membership:member_edit' member.pk %}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href="{% url 'membership:member_delete' member.pk %}" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Primary Information -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person"></i> Primary Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Membership Number:</th>
                            <td><strong>{{ member.membership_number }}</strong></td>
                        </tr>
                        <tr>
                            <th>Full Name:</th>
                            <td>{{ member.name }}</td>
                        </tr>
                        <tr>
                            <th>Phone Number:</th>
                            <td>{{ member.phone_number }}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>{{ member.email }}</td>
                        </tr>
                        <tr>
                            <th>Permanent Address:</th>
                            <td>{{ member.permanent_address }}</td>
                        </tr>
                        <tr>
                            <th>Current Address:</th>
                            <td>{{ member.current_address }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Secondary Information -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Secondary Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Father's Name:</th>
                            <td>{{ member.father_name }}</td>
                        </tr>
                        <tr>
                            <th>Mother's Name:</th>
                            <td>{{ member.mother_name }}</td>
                        </tr>
                        <tr>
                            <th>Spouse Name:</th>
                            <td>{{ member.spouse_name|default:"N/A" }}</td>
                        </tr>
                        <tr>
                            <th>Citizenship Number:</th>
                            <td>{{ member.citizenship_number }}</td>
                        </tr>
                        <tr>
                            <th>Issue Date:</th>
                            <td>{{ member.citizenship_issue_date|date:"M d, Y"|default:"N/A" }}</td>
                        </tr>
                        <tr>
                            <th>Issue District:</th>
                            <td>{{ member.citizenship_issue_district|default:"N/A" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Membership Details with Status -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-card-checklist"></i> Membership Details</h5>
                </div>
                <div class="card-body">
                    {% with status=member.get_membership_status %}
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Membership Type:</th>
                            <td>
                                <span class="badge {% if member.membership_type == 'LIFETIME' %}bg-primary{% else %}bg-info{% endif %}">
                                    {{ member.get_membership_type_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Payment Frequency:</th>
                            <td>{{ member.get_payment_frequency_display }}</td>
                        </tr>
                        <tr>
                            <th>Join Date:</th>
                            <td>{{ member.join_date|date:"F d, Y" }}</td>
                        </tr>
                        <tr>
                            <th>Membership Status:</th>
                            <td>
                                <span class="badge 
                                    {% if status.status == 'ACTIVE' %}bg-success
                                    {% elif status.status == 'EXPIRING' %}bg-warning
                                    {% elif status.status == 'EXPIRED' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ status.status_display }}
                                </span>
                            </td>
                        </tr>
                        {% if member.last_payment_date %}
                        <tr>
                            <th>Last Payment:</th>
                            <td>{{ member.last_payment_date|date:"F d, Y" }}</td>
                        </tr>
                        {% endif %}
                        {% if member.membership_valid_until %}
                        <tr>
                            <th>Valid Until:</th>
                            <td>
                                {{ member.membership_valid_until|date:"F d, Y" }}
                                {% if status.days_remaining %}
                                    <br><small class="text-muted">
                                        {% if status.days_remaining > 0 %}
                                            ({{ status.days_remaining }} days remaining)
                                        {% else %}
                                            (Expired {{ status.days_remaining|cut:"-" }} days ago)
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Status Message:</th>
                            <td>
                                <small class="
                                    {% if status.is_expired %}text-danger
                                    {% elif status.status == 'EXPIRING' %}text-warning
                                    {% else %}text-success{% endif %}">
                                    <i class="bi bi-info-circle"></i> {{ status.message }}
                                </small>
                            </td>
                        </tr>
                        <tr>
                            <th>Total Paid:</th>
                            <td class="text-success fw-bold">NPR {{ total_paid|floatformat:2 }}</td>
                        </tr>
                    </table>
                    {% endwith %}
                </div>
            </div>
        </div>

        <!-- Children -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Children</h5>
                </div>
                <div class="card-body">
                    {% if children %}
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Date of Birth</th>
                                <th>Gender</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for child in children %}
                            <tr>
                                <td>{{ child.name }}</td>
                                <td>{{ child.date_of_birth|date:"M d, Y"|default:"N/A" }}</td>
                                <td>{{ child.get_gender_display|default:"N/A" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">No children registered.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Payment History</h5>
                </div>
                <div class="card-body">
                    {% if payments %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment Mode</th>
                                    <th>Collected By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                <tr>
                                    <td>{{ payment.receipt_number }}</td>
                                    <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                                    <td class="text-success fw-bold">NPR {{ payment.amount|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ payment.get_payment_mode_display }}
                                        </span>
                                    </td>
                                    <td>{{ payment.collected_by|default:"N/A" }}</td>
                                    <td>
                                        <a href="{% url 'membership:payment_receipt' payment.pk %}" 
                                           class="btn btn-sm btn-outline-success" target="_blank">
                                            <i class="bi bi-file-earmark-text"></i> Receipt
                                        </a>
                                        <a href="{% url 'membership:payment_edit' payment.pk %}" 
                                           class="btn btn-sm btn-warning">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'membership:payment_delete' payment.pk %}" 
                                           class="btn btn-sm btn-danger">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No payments recorded yet.</p>
                    <a href="{% url 'membership:payment_add' %}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Record First Payment
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}