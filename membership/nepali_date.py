"""
Nepali Date Converter
Converts English dates to Nepali (BS - Bikram Sambat) dates
"""
from datetime import date


class NepaliDate:
    """Simple Nepali date converter for common dates"""
    
    # Reference data: Days in each Nepali month for years 2000-2089 BS
    NEPALI_CALENDAR = {
        2000: [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2001: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2002: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2003: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2004: [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2005: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2006: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2007: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2008: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2009: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2010: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2011: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2012: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2013: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2014: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2015: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2016: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2017: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2018: [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2019: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2020: [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2021: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2022: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2023: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2024: [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2025: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2026: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2027: [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2028: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2029: [31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30],
        2030: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2031: [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2032: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2033: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2034: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2035: [30, 32, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2036: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2037: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2038: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2039: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2040: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2041: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2042: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2043: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2044: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2045: [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2046: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2047: [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2048: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2049: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2050: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2051: [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2052: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2053: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2054: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2055: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2056: [31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30],
        2057: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2058: [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2059: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2060: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2061: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2062: [30, 32, 31, 32, 31, 31, 29, 30, 29, 30, 29, 31],
        2063: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2064: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2065: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2066: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2067: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2068: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2069: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2070: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2071: [31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30],
        2072: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2073: [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2074: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2075: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2076: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2077: [30, 32, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2078: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2079: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2080: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2081: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2082: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2083: [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2084: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2085: [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2086: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2087: [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2088: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2089: [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
    }
    
    # English to Nepali month names
    MONTH_NAMES = [
        'Baisakh', 'Jestha', 'Ashadh', 'Shrawan', 'Bhadra', 'Ashwin',
        'Kartik', 'Mangsir', 'Poush', 'Magh', 'Falgun', 'Chaitra'
    ]
    
    # Reference date: 2000-01-01 BS = 1943-04-14 AD
    REFERENCE_DATE_AD = date(1943, 4, 14)
    REFERENCE_DATE_BS = (2000, 1, 1)
    
    @classmethod
    def ad_to_bs(cls, ad_date):
        """
        Convert AD date to BS date
        Returns tuple: (year, month, day) or None if out of range
        """
        if not ad_date:
            return None
        
        # Calculate difference in days from reference date
        delta = (ad_date - cls.REFERENCE_DATE_AD).days
        
        # Start from reference BS date
        bs_year, bs_month, bs_day = cls.REFERENCE_DATE_BS
        
        if delta >= 0:
            # Forward calculation
            while delta > 0:
                if bs_year not in cls.NEPALI_CALENDAR:
                    return None  # Out of range
                
                days_in_month = cls.NEPALI_CALENDAR[bs_year][bs_month - 1]
                days_remaining = days_in_month - bs_day + 1
                
                if delta >= days_remaining:
                    delta -= days_remaining
                    bs_day = 1
                    bs_month += 1
                    if bs_month > 12:
                        bs_month = 1
                        bs_year += 1
                else:
                    bs_day += delta
                    delta = 0
        else:
            # Backward calculation
            delta = abs(delta)
            while delta > 0:
                if bs_year not in cls.NEPALI_CALENDAR:
                    return None  # Out of range
                
                if delta >= bs_day:
                    delta -= bs_day
                    bs_month -= 1
                    if bs_month < 1:
                        bs_month = 12
                        bs_year -= 1
                        if bs_year not in cls.NEPALI_CALENDAR:
                            return None
                    bs_day = cls.NEPALI_CALENDAR[bs_year][bs_month - 1]
                else:
                    bs_day -= delta
                    delta = 0
        
        return (bs_year, bs_month, bs_day)
    
    @classmethod
    def format_nepali_date(cls, ad_date, format_type='short'):
        """
        Format Nepali date in various formats
        
        Args:
            ad_date: Python date object
            format_type: 'short' (2081-03-15), 'medium' (15 Ashadh 2081), 'long' (15 Ashadh, 2081)
        
        Returns:
            Formatted string or empty string if conversion fails
        """
        bs_date = cls.ad_to_bs(ad_date)
        if not bs_date:
            return ""
        
        year, month, day = bs_date
        
        if format_type == 'short':
            return f"{year:04d}-{month:02d}-{day:02d}"
        elif format_type == 'medium':
            return f"{day} {cls.MONTH_NAMES[month - 1]} {year}"
        elif format_type == 'long':
            return f"{day} {cls.MONTH_NAMES[month - 1]}, {year}"
        else:
            return f"{year:04d}-{month:02d}-{day:02d}"


def convert_to_nepali(ad_date, format_type='short'):
    """
    Convenience function to convert AD date to Nepali
    
    Usage:
        from membership.nepali_date import convert_to_nepali
        nepali = convert_to_nepali(some_date, 'medium')
    """
    return NepaliDate.format_nepali_date(ad_date, format_type)